# 档案管理系统常见 Bug 及解决方案

## 1. customData vs rawCustomData 引用错误

### 问题描述
在代码中存在混用 `customData` 和 `rawCustomData` 的情况，这会导致某些功能无法正常工作。具体表现为：
- 提交档案时报错：`null is not an object (evaluating 'document.getElementById('customData').value')`
- 档案详情显示时可能无法正确显示自定义数据
- 编辑档案时可能无法正确加载原有的自定义数据

### 问题原因
系统在更新过程中将自定义数据的处理方式从解析后的对象（`customData`）改为原始文本（`rawCustomData`），但部分代码仍在使用旧的字段名。

### 需要检查的位置
1. 档案创建相关：
   - 提交表单时的字段获取 ✓
   - 表单元素的 ID 和 name 属性 ✓
   - 表单提交事件处理函数 ✓

2. 档案显示相关：
   - 档案列表渲染 ✓
   - 档案详情显示 ✓
   - 最新档案显示 ✓

3. 档案编辑相关：
   - 编辑对话框的表单字段 ✓
   - 更新请求的数据结构 ✓

### 解决方案
1. 统一使用 `rawCustomData` 作为自定义数据的字段名
2. 更新所有相关的 HTML 元素 ID
3. 更新所有相关的 JavaScript 代码引用
4. 确保服务器端 API 处理逻辑匹配前端的数据结构
5. 添加更多的错误处理和日志输出
6. 验证表单必填字段

### 修复进度
- [x] 更新了档案列表显示逻辑，使用 `rawCustomData` 替代 `customData`
- [x] 修改了自定义数据的显示方式，使用 `<pre>` 标签保持格式
- [x] 更新了表单元素的 ID 从 `customData` 到 `rawCustomData`
- [x] 修复了编辑对话框中的自定义数据处理
- [x] 更新了最新档案显示逻辑
- [x] 添加了表单必填字段验证
- [x] 添加了详细的日志输出
- [ ] 检查并更新服务器端 API 的数据处理逻辑

### 遗留问题
1. 需要确保所有新创建的档案都使用 `rawCustomData` 格式
2. 可能需要迁移旧数据，将 `customData` 转换为 `rawCustomData` 格式
3. 需要更新相关的文档和注释

### 常见错误和解决方法
1. `null is not an object (evaluating 'document.getElementById('customData').value')`
   - 原因：表单元素 ID 不匹配
   - 解决：确保 HTML 中使用 `rawCustomData` 作为 ID
   - 检查：使用浏览器开发者工具确认元素 ID

2. `解析后的标签数据: undefined`
   - 原因：标签数据获取方式不正确
   - 解决：直接从标签容器获取标签文本
   - 检查：确保标签容器存在且包含标签元素

## 2. 标签相关问题

### 问题描述
- 标签池不显示数据
- 新增标签后不会立即显示在标签池中
- 标签选择后不会正确更新到已选标签列表

### 解决方案
1. 确保标签加载函数在页面切换时被正确调用
2. 添加标签后刷新所有相关页面的标签池
3. 正确处理标签选择和取消选择的事件

### 修复进度
- [x] 修复了标签池的显示逻辑
- [x] 添加了标签后的自动刷新功能
- [x] 改进了标签数据的获取方式
- [ ] 优化标签选择的用户体验

## 3. 搜索功能问题

### 问题描述
- 搜索条件不能正确组合
- 标签筛选无效
- 分页显示异常

### 解决方案
1. 确保搜索参数正确构造
2. 正确处理标签筛选的数组参数
3. 统一分页逻辑的处理方式

### 修复进度
- [x] 修复了搜索参数的构造逻辑
- [ ] 优化标签筛选功能
- [ ] 完善分页显示

## 4. 权限控制问题

### 问题描述
- 管理员功能对普通用户可见
- 某些操作未经权限验证就能执行

### 解决方案
1. 统一检查用户角色
2. 在前端和后端都添加权限验证
3. 正确处理登录状态的判断

### 修复进度
- [x] 添加了前端权限检查
- [x] 实现了后端权限验证
- [ ] 优化权限控制的用户体验

## 5. UI 显示问题

### 问题描述
- 标签池布局异常
- 搜索页面元素重叠
- 响应式布局失效

### 解决方案
1. 检查 CSS 类名是否正确
2. 确保响应式样式正确应用
3. 添加必要的间距和布局控制

### 修复进度
- [x] 优化了标签池的布局
- [x] 修复了搜索页面的布局问题
- [ ] 完善响应式布局